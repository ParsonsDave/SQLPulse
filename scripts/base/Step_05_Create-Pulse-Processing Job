SET NOCOUNT ON;

DECLARE @SprocName sysname;
DECLARE @SQL nvarchar(4000);

-- Temp table to hold the list of monitor actions
CREATE TABLE #MonitorActions
(
    ID int IDENTITY(1,1),
    SprocName sysname
);

INSERT INTO #MonitorActions (SprocName)
SELECT SprocName
FROM dbo.ModuleActions
WHERE ActionType = 'CollectData'
  AND IsEnabled = 1
ORDER BY ExecutionOrder, ID;

DECLARE @MaxID int = (SELECT MAX(ID) FROM #MonitorActions);
DECLARE @CurrentID int = 1;

WHILE @CurrentID <= @MaxID
BEGIN
    SELECT @SprocName = SprocName
    FROM #MonitorActions
    WHERE ID = @CurrentID;

    BEGIN TRY
        SET @SQL = N'EXEC ' + QUOTENAME(@SprocName) + N';';
        EXEC (@SQL);

        -- Optional: log success
        INSERT INTO dbo.ModuleExecutionLog
        (
            ActionType,
            SprocName,
            ExecutionTime,
            Success,
            ErrorMessage
        )
        VALUES
        (
            'Monitor',
            @SprocName,
            SYSUTCDATETIME(),
            1,
            NULL
        );
    END TRY
    BEGIN CATCH
        -- Log failure but continue to next module
        INSERT INTO dbo.ModuleExecutionLog
        (
            ActionType,
            SprocName,
            ExecutionTime,
            Success,
            ErrorMessage
        )
        VALUES
        (
            'Monitor',
            @SprocName,
            SYSUTCDATETIME(),
            0,
            ERROR_MESSAGE()
        );
    END CATCH;

    SET @CurrentID += 1;
END;